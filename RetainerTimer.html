<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>リテイナータイマー</title>
<style type="text/css">

@media screen and (max-width: 480px) {
	/* スマホ用 */
	.retainer-box,
	.submarine-box {
		width:98vw;
	}
	
	body, input, button, select {
		font-size:18pt;
	}

	.top-button-area {
		margin-top:2em;
	}

}

body, input, button, select {
	font-size:16pt;
}

.remain-label {
	font-size:32pt;
}


html, body, div {
	box-sizing:border-box;
}

body {
	box-sizing:border-box;
	background-color:black;
	color:white;
}

.timer-box {
	margin:8px;
	width:calc(100% - 16px);
	padding:12px;
	border-radius:16px;
}

.retainer-box {
	border:2px solid silver;
}

.submarine-box {
	border:2px solid yellow;
}

.remain-ttime-div {
	display:inline-block;
}

.timer-box.running .remain-ttime-div {
	display:none;
}

.retainerTime,
.submarineMin,
.submarineHr {
	width:2.5em;
}

.timer-box.complete {
	background-color:red;
	color:yellow;
}

.timer-box button {
	padding-left:16px;
	padding-right:16px;
	height:40px;
	border-radius:8px;
	cursor:pointer;
	
}

.startStopBtn {
}

#retainer-box-template,
#submarine-box-template { 
	display:none;
}

</style>
<script type="text/javascript">

window.addEventListener("load", () => {
	getWakeLock();
	document.addEventListener("visibilitychange", window.getWakeLock);
	window.addEventListener("focusin", (ev) => {
		if (ev.target.tagName == "INPUT" && ev.target.type == "number") {
			let txt = ev.target;
			txt.setAttribute("data-orgval", txt.value);
			txt.value = "";
			
		}
	});
	window.addEventListener("focusout", (ev) => {
		if (ev.target.tagName == "INPUT" && ev.target.getAttribute("data-orgval") != null) {
			let txt = ev.target;
			if (txt.value == "" ) txt.value = txt.getAttribute("data-orgval");
		}
	});
	
	document.getElementById("btnAddRetainer").addEventListener("click", (ev) => {
		let container = document.querySelector("#retainer-box-area");
		let currentCnt = container.querySelectorAll(".retainer-box").length;
		
		let templateDiv = document.querySelector("#retainer-box-template");
		
		let div = templateDiv.cloneNode(true);
		div.setAttribute("id", "retainer-" + currentCnt);
		container.appendChild(div);
		
	});
	
	document.getElementById("btnAddSubmarine").addEventListener("click", (ev) => {
		let container = document.querySelector("#retainer-box-area");
		let currentCnt = container.querySelectorAll(".submarine-box").length;
	
		let div = document.querySelector("#submarine-box-template").cloneNode(true);
		div.removeAttribute("id");
		
		container.appendChild(div);
	});
	
	document.body.addEventListener("click", (ev) => {
		let src = ev.target;
		if (src.classList.contains("delBtn")) {
			let div = src.parentElement;
			while (div.classList.contains("timer-box") == false) {
				div = div.parentElement;
			}
			
			div.parentElement.removeChild(div);
			
		}else if (src.classList.contains("startStopBtn")) {
			let div = src.parentElement;
			while (div.classList.contains("timer-box") == false) {
				div = div.parentElement;
			}
			
			if (src.getAttribute("data-state") == "stop") {
				// 停止⇒開始
				let remainTime = 0;
				if (src.classList.contains("submarine")) {
					
					if (div.querySelector(".submarineHr").value == "") div.querySelector(".submarineHr").value = "0";
					if (div.querySelector(".submarineMin").value == "") div.querySelector(".submarineMin").value = "0";
					
					remainTime = parseInt(div.querySelector(".submarineHr").value, 10) * 60 + parseInt(div.querySelector(".submarineMin").value, 10);
				}else {
					if (div.querySelector(".retainerTime").value == "") div.querySelector(".retainerTime").value = 60;
					remainTime = parseInt(div.querySelector(".retainerTime").value);
				}
				startTimer(div, remainTime);
				
			}else {
				stopTimer(div);
			}
		}
	});
});

var wakeLock = null;
async function getWakeLock() {
	try {
		window.wakeLock = await navigator.wakeLock.request("screen");
	}catch (err) {
		console.log("WakeLock獲得失敗");
	}
};

function startTimer(div, retainerMinutes) {
	let label = div.querySelector(".remain-label");
	let btn = div.querySelector(".startStopBtn");
	div.classList.remove("complete");
	btn.setAttribute("data-state", "running");
	btn.textContent = "STOP";
	div.classList.add("running");
	
	label.textContent = "残り：" + retainerMinutes + "分";
	let completeTime = new Date().getTime() + retainerMinutes * 60000;
	
	let isSubmarine = div.classList.contains("submarine-box");
	
	let timerId = setInterval(() => {
		let remainSeconds = Math.round((completeTime - new Date().getTime()) / 1000);
		if (remainSeconds < 1) {
			stopTimer(div);
			label.textContent = "完了";
			div.classList.add("complete");
			if (isSubmarine) {
				speak("潜水艦、潜水艦、潜水艦");
			}else {
				speak("リテイナーかえってきた");
			}
		}else {
			label.textContent = (isSubmarine ? "潜：" : "リテ：") + formatRemainTime(remainSeconds);
		}
	}, 10000);
	
	div.setAttribute("data-timer-id", timerId);
}

function formatRemainTime(remainSeconds) {
	let hr = (remainSeconds - (remainSeconds % 3600)) / 3600;
	let min = (remainSeconds - (remainSeconds % 60)) / 60 - (hr * 60);
	let sec = remainSeconds % 60;
	
	
	if (hr > 0) {
		return hr + "時間" + min + "分";
	}else {
		return min + "分" + sec + "秒";
	}
}

function stopTimer(div) {
	let btn = div.querySelector(".startStopBtn");
	btn.setAttribute("data-state", "stop");
	btn.textContent = "START";
	div.classList.remove("running");
	
	clearTimeout(parseInt(div.getAttribute("data-timer-id"), 0));
	
	div.classList.remove("running");
}

function speak(txt) {

	speechSynthesis.speak(new SpeechSynthesisUtterance(txt));
}

</script>
</head>
<body style="height:100%;">
<div class="top-button-area">
	<button id="btnAddRetainer" type="button">リテイナー追加</button>
	<button id="btnAddSubmarine" type="button">潜水艦追加</button>
</div>
<div id="retainer-box-area"></div>


<div id="retainer-box-template" class="retainer-box timer-box">
	<div class="remain-ttime-div">収集時間：<input type="number" list="retainer-times" class="retainerTime">分</div>
	<button type="button" class="startStopBtn" data-state="stop">START</button><button type="button" class="delBtn">消</button>
	<span class="remain-label"></span>
</div>


<div id="submarine-box-template" class="submarine-box timer-box">
	<div class="remain-ttime-div">時間：<input type="number" class="submarineHr" name="submarineHr" min="0" max="24">時間<input type="number" class="submarineMin" name="submarineMin" min="0" max="60">分</div>
	<button type="button" class="startStopBtn submarine" data-state="stop">START</button><button type="button" class="delBtn">消</button>
	<span class="remain-label"></span>
</div>

<datalist id="retainer-times">
	<option value="60"></option>
	<option value="50"></option>
	<option value="40"></option>
	<option value="30"></option>
</datalist>

</body>
</html>

